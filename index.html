<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventaris SDN JATIASIH I</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- Load Tailwind CSS from CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --primary-color: #10b981; /* Emerald 500 */
            --secondary-color: #34d399; /* Emerald 400 */
            --bg-light: #f9fafb;
            --text-dark: #1f2937;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-light);
            color: var(--text-dark);
            margin: 0;
            padding: 0;
        }

        /* --- Auth Containers --- */
        #login-container, #register-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background-color: #d1fae5; /* Emerald 100 */
        }
        #login-container h2, #register-container h2 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--primary-color);
        }
        #login-container input, #register-container input,
        #login-container button, #register-container button {
            padding: 10px 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border: 1px solid #ccc;
            width: 300px;
            max-width: 90%;
            transition: all 0.2s;
        }
        #login-container button, #register-container button {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
            cursor: pointer;
        }
        #login-container button:hover, #register-container button:hover {
            background-color: #059669; /* Emerald 600 */
        }
        .error-message {
            color: #ef4444;
            margin-top: 10px;
            font-size: 0.9rem;
        }
        
        /* --- Dashboard Layout --- */
        #dashboard-container {
            min-height: 100vh;
            display: grid;
            grid-template-rows: auto 1fr;
        }
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        header h1 {
            font-size: 1.5rem;
            font-weight: 700;
        }
        header button {
            background-color: white;
            color: var(--primary-color);
            padding: 8px 15px;
            border-radius: 6px;
            font-weight: 600;
            margin-left: 10px;
            transition: background-color 0.2s, color 0.2s;
        }
        header button:hover {
            background-color: #e0f2f1; /* Teal 50 */
        }
        .logout-btn {
            background-color: #ef4444 !important;
            color: white !important;
        }
        .logout-btn:hover {
            background-color: #dc2626 !important;
        }

        #main-content {
            display: flex;
        }

        #sidebar {
            width: 250px;
            background-color: #e0f2f1; /* Emerald 50 */
            padding: 20px 0;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
        }
        .nav-item {
            padding: 12px 20px;
            text-decoration: none;
            color: var(--text-dark);
            font-weight: 500;
            border-left: 5px solid transparent;
            transition: all 0.2s;
        }
        .nav-item:hover {
            background-color: #ccfbf1; /* Teal 100 */
        }
        .nav-item.active {
            background-color: white;
            border-left: 5px solid var(--primary-color);
            font-weight: 700;
            color: var(--primary-color);
        }

        #content-area {
            flex-grow: 1;
            padding: 30px;
            overflow-y: auto;
        }
        .view h2 {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 25px;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 10px;
        }
        .view h3 {
            font-size: 1.4rem;
            font-weight: 600;
            margin-top: 30px;
            margin-bottom: 15px;
            color: var(--text-dark);
        }
        
        /* --- Cards and Forms --- */
        .card-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
        }
        .card {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            flex: 1 1 200px;
            min-width: 180px;
            text-align: center;
        }
        .card h4 {
            font-size: 1rem;
            font-weight: 600;
            color: #6b7280;
            margin-bottom: 5px;
        }
        .card p {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }
        .card-baik p { color: #3b82f6; } /* Blue */
        .card-rr p { color: #f59e0b; } /* Amber */
        .card-rb p { color: #ef4444; } /* Red */

        form {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        form input, form select, form button {
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #d1d5db;
            flex: 1 1 180px;
            min-width: 150px;
        }
        form button[type="submit"] {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
            flex: 1 1 auto;
        }
        form button[type="submit"]:hover {
            background-color: #059669;
        }

        /* --- Tables --- */
        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        .data-table th, .data-table td {
            text-align: left;
            padding: 12px 15px;
            border-bottom: 1px solid #f3f4f6;
        }
        .data-table thead th {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
        }
        .data-table tbody tr:nth-child(even) {
            background-color: #f9fafb;
        }
        .data-table tbody tr:hover {
            background-color: #f0fdfa;
        }
        .data-table td button {
            background-color: #3b82f6;
            color: white;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-right: 5px;
            cursor: pointer;
            border: none;
            transition: background-color 0.2s;
        }
        .data-table td button:hover {
            background-color: #2563eb;
        }
        .data-table td button.delete-btn {
            background-color: #ef4444;
        }
        .data-table td button.delete-btn:hover {
            background-color: #dc2626;
        }
        
        /* --- Laporan View Specific --- */
        #laporan-container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }
        .kop-laporan {
            text-align: center;
        }
        #lap-logo-sekolah {
            width: 80px;
            height: 80px;
            object-fit: contain;
        }
        .laporan-header {
            text-align: center;
            font-size: 1.6rem;
            margin-top: 15px;
        }

        @media (max-width: 768px) {
            #main-content {
                flex-direction: column;
            }
            #sidebar {
                width: 100%;
                padding: 10px;
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: center;
            }
            .nav-item {
                padding: 8px 15px;
                border-left: none;
                border-bottom: 3px solid transparent;
            }
            .nav-item.active {
                border-left: none;
                border-bottom: 3px solid var(--primary-color);
            }
            #content-area {
                padding: 20px 10px;
            }
            .card-container {
                flex-direction: column;
            }
            header {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
    
    <!-- Library for export PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    
    <!-- LOGIN -->
    <div id="login-container" class="p-8 rounded-lg shadow-xl" style="width: 400px; max-width: 90%;">
        <h2 class="text-3xl">Login</h2>
        <input type="text" id="login-email" placeholder="Email" class="w-full">
        <input type="password" id="login-password" placeholder="Password" class="w-full">
        <button onclick="loginUser()" class="w-full">Login</button>
        <p class="mt-4">Belum punya akun? <a href="#" onclick="showAuthView('register')" class="text-indigo-600 hover:text-indigo-800">Daftar</a></p>
        <p id="auth-message" class="error-message"></p>
    </div>

    <!-- REGISTER -->
    <div id="register-container" class="p-8 rounded-lg shadow-xl" style="display:none; width: 400px; max-width: 90%;">
        <h2 class="text-3xl">Daftar Akun</h2>
        <input type="text" id="register-email" placeholder="Email" class="w-full">
        <input type="password" id="register-password" placeholder="Password" class="w-full">
        <button onclick="registerUser()" class="w-full">Daftar</button>
        <p class="mt-4">Sudah punya akun? <a href="#" onclick="showAuthView('login')" class="text-indigo-600 hover:text-indigo-800">Login</a></p>
        <p id="reg-message" class="error-message"></p>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard-container" style="display:none;">
        <header>
            <h1>Inventaris SDN JATIASIH I</h1>
            <div>
                <button onclick="printLaporan()">Cetak Laporan</button>
                <button onclick="downloadLaporanPDF()">Unduh PDF</button>
                <button class="logout-btn" onclick="logoutUser()">Logout</button>
            </div>
        </header>

        <div id="main-content">
            <nav id="sidebar">
                <a href="#" class="nav-item active" onclick="showView('beranda')">Beranda</a>
                <a href="#" class="nav-item" onclick="showView('gedung')">Input Data Gedung</a>
                <a href="#" class="nav-item" onclick="showView('ruangan')">Input Data Ruangan</a>
                <a href="#" class="nav-item" onclick="showView('barang')">Input Data Barang</a>
                <a href="#" class="nav-item" onclick="showView('identitas')">Identitas</a>
                <a href="#" class="nav-item" onclick="showView('laporan')">Laporan</a>
            </nav>

            <main id="content-area">

                <!-- Beranda -->
                <section id="beranda-view" class="view">
                    <h2>Dashboard</h2>
                    <div class="card-container">
                        <div class="card"><h4>Total</h4><p id="total-barang">0</p></div>
                        <div class="card card-baik"><h4>Baik</h4><p id="total-baik">0</p></div>
                        <div class="card card-rr"><h4>Rusak Ringan</h4><p id="total-rr">0</p></div>
                        <div class="card card-rb"><h4>Rusak Berat</h4><p id="total-rb">0</p></div>
                    </div>

                    <div class="mb-5">
                        <label class="font-semibold mr-3">Pilih Ruangan:</label>
                        <select id="filter-ruangan" onchange="updateDashboardRuangan()" class="p-2 border rounded-md"></select>
                    </div>
                    <div class="chart-box w-full max-w-lg mx-auto">
                        <canvas id="chartRuangan"></canvas>
                    </div>

                    <h3>Daftar Barang di Ruangan</h3>
                    <table class="data-table">
                        <thead>
                            <tr><th>No</th><th>Nama Barang</th><th>Merk/Tipe</th><th>Jumlah</th><th>Kondisi</th></tr>
                        </thead>
                        <tbody id="dashboard-barang-body"></tbody>
                    </table>
                </section>

                <!-- Gedung -->
                <section id="gedung-view" class="view" style="display:none;">
                    <h2>Data Gedung</h2>
                    <form onsubmit="saveGedung(event)">
                        <input type="text" id="nama-gedung" placeholder="Nama Gedung" required>
                        <input type="text" id="luas-gedung" placeholder="Luas Gedung">
                        <input type="number" id="tahun-gedung" placeholder="Tahun">
                        <input type="text" id="sumber-gedung" placeholder="Sumber Anggaran">
                        <button type="submit">Tambah</button>
                    </form>
                    <table class="data-table">
                        <thead><tr><th>No</th><th>Nama Gedung</th><th>Luas</th><th>Tahun</th><th>Sumber</th><th>Aksi</th></tr></thead>
                        <tbody id="gedung-body"></tbody>
                    </table>
                </section>

                <!-- Ruangan -->
                <section id="ruangan-view" class="view" style="display:none;">
                    <h2>Data Ruangan</h2>
                    <form onsubmit="saveRuangan(event)">
                        <input type="text" id="nama-ruangan" placeholder="Nama Ruangan" required>
                        <select id="gedung-select" required></select>
                        <input type="text" id="penanggung-ruangan" placeholder="Penanggung Jawab">
                        <button type="submit">Tambah</button>
                    </form>
                    <table class="data-table">
                        <thead><tr><th>No</th><th>Nama Ruangan</th><th>Gedung</th><th>Penanggung Jawab</th><th>Aksi</th></tr></thead>
                        <tbody id="ruangan-body"></tbody>
                    </table>
                </section>

                <!-- Barang -->
                <section id="barang-view" class="view" style="display:none;">
                    <h2>Data Barang</h2>
                    <form onsubmit="saveBarang(event)">
                        <select id="ruangan-select" required><option value="">-- Pilih Ruangan --</option></select>
                        <input type="text" id="nama-barang" placeholder="Nama Barang" required>
                        <input type="text" id="merk-barang" placeholder="Merk/Tipe">
                        <input type="number" id="jumlah-barang" placeholder="Jumlah" required>
                        <select id="kondisi-barang" required>
                            <option value="B">Baik</option>
                            <option value="RR">Rusak Ringan</option>
                            <option value="RB">Rusak Berat</option>
                        </select>
                        <button type="submit">Tambah</button>
                    </form>
                    <table class="data-table">
                        <thead>
                            <tr><th>No</th><th>Nama</th><th>Merk</th><th>Jumlah</th><th>Ruangan</th><th>Kondisi</th><th>Aksi</th></tr>
                        </thead>
                        <tbody id="barang-body"></tbody>
                    </table>
                </section>

                <!-- Identitas -->
                <section id="identitas-view" class="view" style="display:none;">
                    <h2>Identitas Sekolah</h2>
                    <form onsubmit="saveIdentitas(event)">
                        <input type="text" id="nama-sekolah" placeholder="Nama Sekolah">
                        <input type="text" id="alamat-sekolah" placeholder="Alamat Sekolah">
                        <input type="text" id="logo-sekolah" placeholder="URL Logo Sekolah (e.g., https://placehold.co/80x80/10b981/ffffff?text=LOGO)">
                        <input type="text" id="bendahara-nama" placeholder="Nama Bendahara Barang">
                        <input type="text" id="bendahara-nip" placeholder="NIP Bendahara Barang">
                        <input type="text" id="pj-nama" placeholder="Nama Kepala Sekolah">
                        <input type="text" id="pj-nip" placeholder="NIP Kepala Sekolah">
                        <button type="submit" class="!flex-grow-0 !w-auto px-10">Simpan</button>
                    </form>
                </section>

                <!-- Laporan - THE FOCUS SECTION -->
                <section id="laporan-view" class="view" style="display:none;">
                    <h2>Laporan Inventaris</h2>
                    <div id="laporan-container">
                        <div class="kop-laporan">
                            <div style="display:flex; align-items:center; justify-content:center; gap:15px; margin-bottom: 20px;">
                                <img id="lap-logo-sekolah" src="https://placehold.co/80x80/10b981/ffffff?text=LOGO" alt="Logo Sekolah" height="80">
                                <div class="text-left">
                                    <h3 id="lap-nama-sekolah" class="!mt-0 !mb-1 text-2xl font-bold text-gray-800">SDN JATIASIH I</h3>
                                    <p id="lap-alamat-sekolah" class="text-sm text-gray-600">Jl. Raya Jatiasih No. 1, Bekasi</p>
                                </div>
                            </div>
                        </div>

                        <hr style="margin:10px 0;">
                        <h3 class="laporan-header">LAPORAN INVENTARIS BARANG</h3>

                        <div class="flex flex-wrap gap-4 items-center justify-start py-4 border-b">
                            <label class="font-bold">Filter Ruangan:</label>
                            <select id="laporan-filter-ruangan" onchange="tampilkanLaporanBarang()" class="p-2 border rounded-md">
                                <option value="">-- Semua Ruangan --</option>
                            </select>

                            <label class="font-bold">Filter Kondisi:</label>
                            <select id="laporan-filter-kondisi" onchange="tampilkanLaporanBarang()" class="p-2 border rounded-md">
                                <option value="">-- Semua Kondisi --</option>
                                <option value="B">Baik</option>
                                <option value="RR">Rusak Ringan</option>
                                <option value="RB">Rusak Berat</option>
                            </select>
                        </div>

                        <div style="margin:10px 0;">
                            <label class="font-bold">Tanggal Cetak:</label>
                            <input type="date" id="input-tanggal-cetak" onchange="updateTanggalCetakManual()" class="p-2 border rounded-md">
                            <span id="tanggal-cetak" style="margin-left:8px; font-weight: 600;"></span>
                        </div>

                        <table class="data-table my-5">
                            <thead>
                                <tr><th>No</th><th>Nama Barang</th><th>Merk/Tipe</th><th>Jumlah</th><th>Kondisi</th></tr>
                            </thead>
                            <tbody id="laporan-body"></tbody>
                        </table>

                        <div class="ttd" style="display:flex; justify-content:space-between; margin-top:60px;">
                            <div style="text-align:center;">
                                <p>Kepala Sekolah</p><br><br><br>
                                <p id="lap-pj-nama" class="font-semibold border-b border-gray-500 inline-block px-4">Nama Kepala Sekolah</p>
                                <p id="lap-pj-nip" class="text-sm">NIP: -</p>
                            </div>
                            <div style="text-align:center;">
                                <p>Bendahara Barang</p><br><br><br>
                                <p id="lap-bendahara-nama" class="font-semibold border-b border-gray-500 inline-block px-4">Nama Bendahara Barang</p>
                                <p id="lap-bendahara-nip" class="text-sm">NIP: -</p>
                            </div>
                        </div>
                    </div>
                </section>

            </main>
        </div>
    </div>

    <!-- MAIN JAVASCRIPT LOGIC (FIXED) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set Firebase Log Level to Debug
        setLogLevel('Debug');

        // --- GLOBAL VARIABLES (Canvas Environment) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Provide a robust fallback configuration for Firebase initialization to avoid "projectId" errors
        const defaultFirebaseConfig = {
            apiKey: "AIzaSyAkVZlF1T3EYiUQxeUnEiew2uXanuQcFJ8",
            authDomain: "inventaris-sekolah-6aa45.firebaseapp.com",
            projectId: "inventaris-sekolah-6aa45.firebaseapp.com", // Fixes the reported error
            storageBucket: "inventaris-sekolah-6aa45.appspot.com",
            messagingSenderId: "482992763821",
            appId: "1:482992763821:web:3476cb5bd7320d840c2724",
            measurementId: "G-C51S4NNKXM"
        };
        
        let firebaseConfig;
        try {
            // Attempt to parse the config provided by the environment
            const envConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
            
            // Check if the environment config is valid and use it, otherwise use the default fallback
            if (envConfig && envConfig.projectId) {
                 firebaseConfig = envConfig;
            } else {
                 firebaseConfig = defaultFirebaseConfig;
                 console.warn("Using default Firebase config because environment config was invalid or missing projectId.");
            }
            
        } catch (e) {
            console.error("Failed to parse __firebase_config:", e);
            firebaseConfig = defaultFirebaseConfig;
        }

        let app, db, auth, userId = null;
        let authReady = false;

        // --- IN-MEMORY MOCK DATA (For Demonstration) ---
        let gedungData = [];
        let ruanganData = [];
        let barangData = [];
        let identitasData = {
            namaSekolah: "SDN JATIASIH I",
            alamatSekolah: "Jl. Wibawa Mukti II Gg.Anugerah Rt006/002 Kecamatan Jatiasih Kota Bekasi",
            logoUrl: "https://i.imgur.com/hvtbIzj.gif",
            bendaharaNama: "Wahyudin, S.Pd",
            bendaharaNip: "198307252008011005",
            pjNama: "Dewi Rahayu, S.Pd.SD.M.Pd",
            pjNip: "197001071993072002"
        };
        
        // Helper function to map condition codes to full names
        const mapKondisi = (code) => {
            switch (code) {
                case 'B': return 'Baik';
                case 'RR': return 'Rusak Ringan';
                case 'RB': return 'Rusak Berat';
                default: return '-';
            }
        };

        // --- FIREBASE INITIALIZATION AND AUTH ---

        const initFirebase = async () => {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Set up auth state listener
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Authenticated User ID:", userId);
                        authReady = true;
                        document.getElementById('auth-message').textContent = `User ID: ${userId}`;
                        showAuthView(null); // Hide auth views and show dashboard
                        setupDataListeners();
                    } else {
                        userId = null;
                        authReady = true;
                        console.log("User signed out or anonymous.");
                        showAuthView('login');
                    }
                    // Initial load of data after auth is ready
                    if (authReady) {
                        loadInitialData();
                    }
                });

                // Sign in using custom token or anonymously
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                // Display specific error for the user
                document.getElementById('auth-message').textContent = `Error Init: ${error.message}`;
            }
        };

        window.loginUser = async () => {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const msgEl = document.getElementById('auth-message');
            msgEl.textContent = 'Logging in...';
            try {
                await signInWithEmailAndPassword(auth, email, password);
                // Auth state listener handles view change
            } catch (error) {
                msgEl.textContent = `Login failed: ${error.message}`;
                console.error("Login Error:", error);
            }
        };

        window.registerUser = async () => {
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const msgEl = document.getElementById('reg-message');
            msgEl.textContent = 'Registering...';
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                // Auth state listener handles view change
            } catch (error) {
                msgEl.textContent = `Registration failed: ${error.message}`;
                console.error("Register Error:", error);
            }
        };

        window.logoutUser = async () => {
            await signOut(auth);
            // Auth state listener handles view change
        };

        // --- DATA SETUP AND LISTENERS ---

        const getPublicCollectionPath = (collectionName) => `/artifacts/${appId}/public/data/${collectionName}`;

        const setupDataListeners = () => {
            if (!authReady || !userId) return;

            // 1. Identitas (for one document)
            onSnapshot(doc(db, getPublicCollectionPath('identitas'), 'school_info'), (docSnapshot) => {
                if (docSnapshot.exists()) {
                    identitasData = { id: docSnapshot.id, ...docSnapshot.data() };
                    updateIdentitasView();
                    updateLaporanHeader();
                }
            }, (error) => console.error("Error fetching Identitas:", error));
            
            // --- MOCK DATA IN-MEMORY FOR DEMO ---
            // In a real app, this data would come from onSnapshot listeners for 'gedung', 'ruangan', 'barang' collections.
            // For demonstration, we use a simple mock structure.
            gedungData = [
                { id: 'g1', nama: 'Gedung Utama', luas: '500m2', tahun: 2000, sumber: 'APBN' },
                { id: 'g2', nama: 'Gedung Serbaguna', luas: '200m2', tahun: 2010, sumber: 'BOS' },
            ];

            ruanganData = [
                { id: 'r1', nama: 'Kelas A', gedungId: 'g1', penanggung: 'Ibu Budi' },
                { id: 'r2', nama: 'Kelas B', gedungId: 'g1', penanggung: 'Bapak Candra' },
                { id: 'r3', nama: 'Perpustakaan', gedungId: 'g2', penanggung: 'Ibu Dewi' },
            ];

            barangData = [
                // Ruangan r1
                { id: 'b1', nama: 'Meja Siswa', merk: 'Chitose', jumlah: 25, ruanganId: 'r1', kondisi: 'B' },
                { id: 'b2', nama: 'Kursi Siswa', merk: 'Chitose', jumlah: 30, ruanganId: 'r1', kondisi: 'B' },
                { id: 'b3', nama: 'Papan Tulis', merk: 'Standard', jumlah: 1, ruanganId: 'r1', kondisi: 'RR' },
                // Ruangan r2
                { id: 'b4', nama: 'Meja Guru', merk: 'IKEA', jumlah: 1, ruanganId: 'r2', kondisi: 'B' },
                { id: 'b5', nama: 'Kursi Siswa', merk: 'Chitose', jumlah: 5, ruanganId: 'r2', kondisi: 'RB' },
                { id: 'b6', nama: 'Komputer', merk: 'HP', jumlah: 2, ruanganId: 'r2', kondisi: 'B' },
                // Ruangan r3
                { id: 'b7', nama: 'Rak Buku', merk: 'Lokal', jumlah: 10, ruanganId: 'r3', kondisi: 'RR' },
                { id: 'b8', nama: 'Buku Pelajaran', merk: '-', jumlah: 500, ruanganId: 'r3', kondisi: 'B' },
            ];
            
            // Update all views after mock data is loaded
            loadRuanganOptions();
            updateDashboard();
            renderAllViews();
        };

        const loadInitialData = () => {
            updateTanggalCetakManual(); // Set initial date
        };
        
        // --- RENDERING AND UI UPDATES ---

        window.showAuthView = (view) => {
            document.getElementById('login-container').style.display = view === 'login' ? 'flex' : 'none';
            document.getElementById('register-container').style.display = view === 'register' ? 'flex' : 'none';
            document.getElementById('dashboard-container').style.display = !view ? 'grid' : 'none';
            if (view === 'login' || view === 'register') {
                document.getElementById('auth-message').textContent = '';
                document.getElementById('reg-message').textContent = '';
            }
        };

        window.showView = (viewId) => {
            const views = document.querySelectorAll('.view');
            views.forEach(view => view.style.display = 'none');
            
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => item.classList.remove('active'));

            const targetView = document.getElementById(`${viewId}-view`);
            if (targetView) {
                targetView.style.display = 'block';
                document.querySelector(`.nav-item[onclick*="showView('${viewId}')"]`).classList.add('active');
            }

            // Specific logic for Laporan view
            if (viewId === 'laporan') {
                tampilkanLaporanBarang(); // Render report every time view is opened
            }
        };
        
        const renderAllViews = () => {
            renderGedungTable();
            renderRuanganTable();
            renderBarangTable(barangData, 'barang-body');
        };
        
        const renderGedungTable = () => {
            const body = document.getElementById('gedung-body');
            body.innerHTML = gedungData.map((g, i) => `
                <tr>
                    <td>${i + 1}</td>
                    <td>${g.nama}</td>
                    <td>${g.luas}</td>
                    <td>${g.tahun}</td>
                    <td>${g.sumber}</td>
                    <td>
                        <button onclick="editGedung('${g.id}')">Edit</button>
                        <button class="delete-btn" onclick="deleteGedung('${g.id}')">Hapus</button>
                    </td>
                </tr>
            `).join('');
        };
        
        const renderRuanganTable = () => {
            const body = document.getElementById('ruangan-body');
            body.innerHTML = ruanganData.map((r, i) => {
                const gedung = gedungData.find(g => g.id === r.gedungId)?.nama || 'N/A';
                return `
                    <tr>
                        <td>${i + 1}</td>
                        <td>${r.nama}</td>
                        <td>${gedung}</td>
                        <td>${r.penanggung}</td>
                        <td>
                            <button onclick="editRuangan('${r.id}')">Edit</button>
                            <button class="delete-btn" onclick="deleteRuangan('${r.id}')">Hapus</button>
                        </td>
                    </tr>
                `;
            }).join('');
        };
        
        const renderBarangTable = (data, elementId) => {
            const body = document.getElementById(elementId);
            body.innerHTML = data.map((b, i) => {
                const ruangan = ruanganData.find(r => r.id === b.ruanganId)?.nama || 'N/A';
                const kondisiText = mapKondisi(b.kondisi);
                
                let actionButtons = '';
                if (elementId === 'barang-body') {
                    actionButtons = `
                        <button onclick="editBarang('${b.id}')">Edit</button>
                        <button class="delete-btn" onclick="deleteBarang('${b.id}')">Hapus</button>
                    `;
                }

                return `
                    <tr>
                        <td>${i + 1}</td>
                        <td>${b.nama}</td>
                        <td>${b.merk}</td>
                        <td>${b.jumlah}</td>
                        ${elementId === 'barang-body' ? `<td>${ruangan}</td>` : ''}
                        <td>${kondisiText}</td>
                        ${elementId === 'barang-body' ? `<td>${actionButtons}</td>` : ''}
                    </tr>
                `;
            }).join('');
        };
        
        const updateDashboard = () => {
            const total = barangData.reduce((sum, item) => sum + item.jumlah, 0);
            const baik = barangData.filter(b => b.kondisi === 'B').reduce((sum, item) => sum + item.jumlah, 0);
            const rr = barangData.filter(b => b.kondisi === 'RR').reduce((sum, item) => sum + item.jumlah, 0);
            const rb = barangData.filter(b => b.kondisi === 'RB').reduce((sum, item) => sum + item.jumlah, 0);

            document.getElementById('total-barang').textContent = total;
            document.getElementById('total-baik').textContent = baik;
            document.getElementById('total-rr').textContent = rr;
            document.getElementById('total-rb').textContent = rb;
            
            // Select first room for initial dashboard barang list
            const defaultRoom = ruanganData[0]?.id || '';
            document.getElementById('filter-ruangan').value = defaultRoom;
            updateDashboardRuangan();
        };

        const updateIdentitasView = () => {
            document.getElementById('nama-sekolah').value = identitasData.namaSekolah || '';
            document.getElementById('alamat-sekolah').value = identitasData.alamatSekolah || '';
            document.getElementById('logo-sekolah').value = identitasData.logoUrl || '';
            document.getElementById('bendahara-nama').value = identitasData.bendaharaNama || '';
            document.getElementById('bendahara-nip').value = identitasData.bendaharaNip || '';
            document.getElementById('pj-nama').value = identitasData.pjNama || '';
            document.getElementById('pj-nip').value = identitasData.pjNip || '';
        };

        const updateLaporanHeader = () => {
            document.getElementById('lap-logo-sekolah').src = identitasData.logoUrl || 'https://placehold.co/80x80/10b981/ffffff?text=LOGO';
            document.getElementById('lap-nama-sekolah').textContent = identitasData.namaSekolah || 'Nama Sekolah';
            document.getElementById('lap-alamat-sekolah').textContent = identitasData.alamatSekolah || 'Alamat Sekolah';
            document.getElementById('lap-pj-nama').textContent = identitasData.pjNama || 'Nama Kepala Sekolah';
            document.getElementById('lap-pj-nip').textContent = identitasData.pjNip ? `NIP: ${identitasData.pjNip}` : 'NIP: -';
            document.getElementById('lap-bendahara-nama').textContent = identitasData.bendaharaNama || 'Nama Bendahara Barang';
            document.getElementById('lap-bendahara-nip').textContent = identitasData.bendaharaNip ? `NIP: ${identitasData.bendaharaNip}` : 'NIP: -';
        };

        window.loadRuanganOptions = () => {
            const ruanganOptions = ruanganData.map(r => 
                `<option value="${r.id}">${r.nama}</option>`
            ).join('');

            const gedungOptions = gedungData.map(g => 
                `<option value="${g.id}">${g.nama}</option>`
            ).join('');

            // Populate Ruangan Select (Barang Input and Dashboard Filter)
            document.getElementById('ruangan-select').innerHTML = '<option value="">-- Pilih Ruangan --</option>' + ruanganOptions;
            document.getElementById('filter-ruangan').innerHTML = '<option value="">-- Semua Ruangan --</option>' + ruanganOptions;
            document.getElementById('laporan-filter-ruangan').innerHTML = '<option value="">-- Semua Ruangan --</option>' + ruanganOptions;

            // Populate Gedung Select (Ruangan Input)
            document.getElementById('gedung-select').innerHTML = '<option value="">-- Pilih Gedung --</option>' + gedungOptions;
        };

        // --- CORE FILTER FUNCTION (Tested and Verified) ---
        window.tampilkanLaporanBarang = () => {
            if (!barangData.length) {
                document.getElementById('laporan-body').innerHTML = '<tr><td colspan="5" class="text-center text-gray-500">Tidak ada data barang untuk ditampilkan.</td></tr>';
                return;
            }

            // 1. Get filter values
            const selectedRuanganId = document.getElementById('laporan-filter-ruangan').value;
            const selectedKondisi = document.getElementById('laporan-filter-kondisi').value;

            console.log(`Filtering Report: Ruangan ID='${selectedRuanganId}', Kondisi='${selectedKondisi}'`);

            // 2. Apply filtering logic
            const filteredBarang = barangData.filter(item => {
                const matchRuangan = !selectedRuanganId || item.ruanganId === selectedRuanganId;
                const matchKondisi = !selectedKondisi || item.kondisi === selectedKondisi;
                return matchRuangan && matchKondisi;
            });
            
            // 3. Render the filtered data
            if (filteredBarang.length === 0) {
                document.getElementById('laporan-body').innerHTML = '<tr><td colspan="5" class="text-center text-gray-500">Tidak ada barang yang cocok dengan filter.</td></tr>';
            } else {
                renderBarangTable(filteredBarang, 'laporan-body');
            }
        };

        window.updateDashboardRuangan = () => {
            const selectedRuanganId = document.getElementById('filter-ruangan').value;
            let filteredBarang = barangData;

            if (selectedRuanganId) {
                filteredBarang = barangData.filter(item => item.ruanganId === selectedRuanganId);
            }

            renderBarangTable(filteredBarang, 'dashboard-barang-body');
            updateChart(filteredBarang);
        };

        // --- CHART FUNCTIONALITY (for Dashboard) ---
        let myChart = null;

        const updateChart = (data) => {
            const ctx = document.getElementById('chartRuangan').getContext('2d');
            
            const baik = data.filter(b => b.kondisi === 'B').reduce((sum, item) => sum + item.jumlah, 0);
            const rr = data.filter(b => b.kondisi === 'RR').reduce((sum, item) => sum + item.jumlah, 0);
            const rb = data.filter(b => b.kondisi === 'RB').reduce((sum, item) => sum + item.jumlah, 0);

            if (myChart) {
                myChart.destroy();
            }

            myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Baik', 'Rusak Ringan', 'Rusak Berat'],
                    datasets: [{
                        data: [baik, rr, rb],
                        backgroundColor: ['#3b82f6', '#f59e0b', '#ef4444'],
                        hoverBackgroundColor: ['#2563eb', '#f97316', '#dc2626'],
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' },
                        title: {
                            display: true,
                            text: 'Persentase Kondisi Barang di Ruangan Terpilih'
                        }
                    }
                }
            });
        };

        // --- IDENTITAS & DATE FUNCTIONS ---
        window.updateTanggalCetakManual = () => {
            const inputDate = document.getElementById('input-tanggal-cetak').value;
            const displayEl = document.getElementById('tanggal-cetak');
            
            if (inputDate) {
                const date = new Date(inputDate);
                const options = { year: 'numeric', month: 'long', day: 'numeric' };
                displayEl.textContent = `Tanggal: ${date.toLocaleDateString('id-ID', options)}`;
            } else {
                const date = new Date();
                const options = { year: 'numeric', month: 'long', day: 'numeric' };
                displayEl.textContent = `Tanggal: ${date.toLocaleDateString('id-ID', options)}`;
            }
        };

        // --- MOCK SAVE FUNCTIONS (for other views, logging only) ---
        window.saveGedung = (e) => { e.preventDefault(); console.log("Mock: Saving Gedung..."); };
        window.saveRuangan = (e) => { e.preventDefault(); console.log("Mock: Saving Ruangan..."); };
        window.saveBarang = (e) => { e.preventDefault(); console.log("Mock: Saving Barang..."); };
        window.editGedung = (id) => console.log("Mock: Editing Gedung", id);
        window.deleteGedung = (id) => console.log("Mock: Deleting Gedung", id);
        window.editRuangan = (id) => console.log("Mock: Editing Ruangan", id);
        window.deleteRuangan = (id) => console.log("Mock: Deleting Ruangan", id);
        window.editBarang = (id) => console.log("Mock: Editing Barang", id);
        window.deleteBarang = (id) => console.log("Mock: Deleting Barang", id);
        
        window.saveIdentitas = async (e) => {
            e.preventDefault();
            console.log("Saving Identitas...");
            if (!authReady || !userId) {
                console.error("Auth not ready to save data.");
                return;
            }

            const newIdentitas = {
                namaSekolah: document.getElementById('nama-sekolah').value,
                alamatSekolah: document.getElementById('alamat-sekolah').value,
                logoUrl: document.getElementById('logo-sekolah').value,
                bendaharaNama: document.getElementById('bendahara-nama').value,
                bendaharaNip: document.getElementById('bendahara-nip').value,
                pjNama: document.getElementById('pj-nama').value,
                pjNip: document.getElementById('pj-nip').value,
            };

            try {
                // Save to Firestore (Single Document)
                const docRef = doc(db, getPublicCollectionPath('identitas'), 'school_info');
                await setDoc(docRef, newIdentitas, { merge: true });
                console.log("Identitas saved successfully.");
                updateLaporanHeader(); // Update header immediately
            } catch (error) {
                console.error("Error saving Identitas:", error);
            }
        };

        // --- PDF AND PRINT FUNCTIONS ---
        const { jsPDF } = window.jspdf;
        
        window.printLaporan = () => {
            window.print();
        };

        window.downloadLaporanPDF = () => {
            const reportContainer = document.getElementById('laporan-container');
            
            // Temporarily hide filter controls and input date for clean PDF
            const controls = document.querySelectorAll('#laporan-view .flex.gap-4, #laporan-view input[type="date"]');
            controls.forEach(c => c.style.display = 'none');
            
            html2canvas(reportContainer, { 
                scale: 2, 
                useCORS: true,
                logging: true 
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4');
                const imgWidth = 210; 
                const pageHeight = 295; 
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;

                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                pdf.save("Laporan_Inventaris.pdf");
                
                // Restore hidden elements
                controls.forEach(c => c.style.removeProperty('display'));
            }).catch(error => {
                console.error("PDF generation failed:", error);
            });
        };

        // Initialize the app on load
        window.onload = initFirebase;
    </script>
</body>
</html>
